# Output Generation Specification

This document specifies the outputs generated by the Agent Knowledge Manager.

## Output Directory Structure

When the `--output` flag is used, the application replicates the organized structure of the input, split by category.

```
output-directory/
├── category-1/         # e.g., "skills"
│   ├── entity-name-1/
│   │   ├── DEFINITION.md
│   │   └── ...
│   └── ...
├── category-2/         # e.g., "personas"
│   └── ...
└── ...
```

## AGENTS.md Format

The `AGENTS.md` file provides a comprehensive summary of all processed entities in an XML format.

### XML Schema

-   **Root Element**: `<persona-context>`
-   **Structure**: The XML structure mirrors the directory category/subcategory hierarchy.
-   **Leaf Elements**: The tag name of the leaf element is the `name` of the entity.
-   **Content**:
    -   Attributes: `path` (relative path to the definition file).
    -   Child Elements: All fields found in the YAML frontmatter of the entity.

### Example

Input structure:
-   `skills/coding/python-helper/SKILL.md` (name: `python-helper`)
-   `personas/creative/writer/PERSONA.md` (name: `writer`)

Generated `AGENTS.md`:

```xml
<persona-context>
  <skills>
    <coding>
      <python-helper path="skills/coding/python-helper/SKILL.md">
        <description>Assists with Python coding tasks.</description>
        <license>MIT</license>
        <!-- All other frontmatter fields included here -->
      </python-helper>
    </coding>
  </skills>
  <personas>
    <creative>
      <writer path="personas/creative/writer/PERSONA.md">
        <description>A creative writing assistant.</description>
        <tone>Inspirational</tone>
      </writer>
    </creative>
  </personas>
</persona-context>
```

## Processing Logic

1.  **Traversal & Validation**: Iterate through all provided input directories (globs). Parse every definition file found.
    -   **Validation Rules**:
        -   **Structure**: Parent directory name must match entity name.
        -   **Frontmatter**: Must be valid YAML with required fields.
        -   **Nesting**: Entity directories may contain one level of subdirectories (e.g., `scripts/`, `assets/`) which are **not** parsed for further entities. Deeply nested directories are not allowed.
    -   **Error Handling**: Collect *all* validation errors and failing files. Report all failures to the user.
    -   **Strictness**: If *any* error is found after processing all files, the entire process aborts.
2.  **Aggregation**: Group valid entities by their category and subcategory paths relative to the input root.
3.  **Generation**:
    -   Construct the XML tree based on the aggregation.
    -   Write `AGENTS.md` to the repository root.
    -   If output directory is specified, write the file artifacts to the destination, preserving the category structure.
